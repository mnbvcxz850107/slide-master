<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å­¸åœ‹è€ƒè¤‡ç¿’ç¥å™¨ (Proç‰ˆ)</title>
    <style>
        /* --- 1. æ•´é«”æ’ç‰ˆ (CSS) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        h1 { margin: 0 0 10px 0; color: #333; font-size: 1.5rem; }
        p.subtitle { color: #666; margin-top: 0; font-size: 0.9rem; }

        /* --- é¸å–®å€åŸŸ --- */
        #menu-area { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .menu-btn {
            background-color: #fff;
            border: 2px solid #007bff;
            color: #007bff;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .menu-btn:hover { background-color: #007bff; color: white; transform: translateY(-2px); }

        /* --- ç­”é¡Œå€åŸŸ --- */
        #game-area { display: none; }
        
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-home { background: #e2e6ea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: #555; }
        .status-text { font-size: 0.9rem; color: #888; }

        /* é¡Œç›®é¡¯ç¤º */
        #question-display { 
            min-height: 150px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            margin: 20px 0;
        }
        .q-text { font-size: 1.3rem; font-weight: bold; line-height: 1.5; text-align: left; width: 100%; white-space: pre-wrap; }
        .q-img { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .q-desc { margin-top: 10px; color: #555; font-size: 1rem; }

        /* æ­£å¸¸å›ç­”å€ */
        .input-area { margin-top: 15px; }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            text-transform: uppercase;
        }
        input[type="text"]:focus { border-color: #007bff; }
        
        /* ç·´ç¿’è¼¸å…¥æ¡† (ç­”éŒ¯æ™‚æ‰å‡ºç¾) */
        #practice-input {
            border-color: #ffcccb; /* é è¨­æ·¡ç´…è‰²æ¡† */
            color: red; /* é è¨­ç´…å­— */
        }
        #practice-input.correct-practice {
            border-color: #28a745 !important;
            color: green !important;
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-submit { background-color: #007bff; }
        .btn-dunno { background-color: #ffc107; color: #333; }
        
        /* è©•ä¼°æŒ‰éˆ• (é¡ä¼¼ Python ç‰ˆ) */
        .assess-btn-group { display: none; margin-top: 10px; justify-content: center; gap: 8px; }
        .btn-clear { background-color: #28a745; } /* ç¶  */
        .btn-vague { background-color: #ffc107; color: black; } /* é»ƒ */
        .btn-forgot { background-color: #dc3545; } /* ç´… */

        /* çµæœå›é¥‹ */
        #feedback { margin-top: 15px; font-size: 1.3rem; font-weight: bold; min-height: 30px; }
        .correct-msg { color: #28a745; }
        .wrong-msg { color: #dc3545; }

        /* ç·´ç¿’å€å¡Š */
        #practice-area { display: none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .practice-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; display: block; }

    </style>
</head>
<body>

<div class="container">
    <h1 id="app-title">ğŸ©º åœ‹è€ƒè¤‡ç¿’ç¥å™¨</h1>
    
    <div id="menu-area">
        <p class="subtitle">è«‹é¸æ“‡è¦ç·´ç¿’çš„ç§‘ç›®ï¼š</p>
        <div id="menu-list"></div>
    </div>

    <div id="game-area">
        <div class="nav-bar">
            <button class="btn-home" onclick="goHome()">ğŸ  å›é¸å–®</button>
            <span class="status-text" id="progress-text"></span>
        </div>

        <div id="question-display"></div>

        <div class="input-area" id="main-input-area">
            <input type="text" id="answer-input" placeholder="è¼¸å…¥ç­”æ¡ˆ (A/B/C/D)" autocomplete="off">
            <div class="btn-group">
                <button class="btn btn-submit" id="btn-submit" onclick="checkAnswer()">é€å‡º</button>
                <button class="btn btn-dunno" id="btn-dunno" onclick="showAnswer()">ä¸çŸ¥é“</button>
            </div>
        </div>

        <div id="feedback"></div>

        <div id="practice-area">
            <label class="practice-label">ğŸ‘‡ ç·´ç¿’è¼¸å…¥æ­£ç¢ºç­”æ¡ˆï¼š</label>
            <input type="text" id="practice-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ..." autocomplete="off">
            
            <div class="assess-btn-group" id="assess-buttons">
                <button class="btn btn-clear" onclick="assess('clear')">ğŸŸ¢ è¨˜ä½äº†</button>
                <button class="btn btn-vague" onclick="assess('vague')">ğŸŸ¡ æ¨¡ç³Š (ç¨å¾Œå†å•)</button>
                <button class="btn btn-forgot" onclick="assess('forgot')">ğŸ”´ å¿˜è¨˜ (é‡å•)</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // âš™ï¸ è¨­å®šå€ï¼šè«‹åœ¨é€™è£¡ä¿®æ”¹ä½ çš„é¡Œåº«æª”æ¡ˆ
    // ========================================================
    const quizList = [
        { name: "ğŸ’€ å¤§é«”è§£å‰–å­¸", file: "anatomy.csv" },
        { name: "ğŸ’Š è—¥ç†å­¸", file: "pharma.csv" },
        { name: "ğŸ¦  å¾®ç”Ÿç‰©", file: "micro.csv" },
        // åœ¨é€™è£¡ä¾æ¨£ç•«è‘«è˜†æ–°å¢...
    ];
    // ========================================================

    let allQuestions = [];
    let currentQ = null;
    let currentIndex = 0;

    // ç¶²é è¼‰å…¥
    window.onload = function() {
        const menuList = document.getElementById('menu-list');
        quizList.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.innerHTML = item.name;
            btn.onclick = () => loadCSV(item.file);
            menuList.appendChild(btn);
        });
        
        // ç¶å®š Enter éµé‚è¼¯
        document.getElementById('answer-input').addEventListener("keypress", function(e) {
            if (e.key === "Enter") checkAnswer();
        });

        // ç¶å®šç·´ç¿’è¼¸å…¥æ¡†çš„è®Šè‰²é‚è¼¯
        document.getElementById('practice-input').addEventListener("input", function(e) {
            checkPracticeInput(e.target.value);
        });
    };

    // è¼‰å…¥ CSV
    async function loadCSV(filename) {
        document.getElementById('menu-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('app-title').style.display = 'none';
        document.getElementById('question-display').innerHTML = '<p>è¼‰å…¥é¡Œåº«ä¸­...</p>';

        try {
            const response = await fetch(filename + '?t=' + new Date().getTime());
            if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
            const text = await response.text();
            parseCSV(text);
        } catch (err) {
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆåç¨±æ˜¯å¦æ­£ç¢ºã€‚");
            goHome();
        }
    }

    function parseCSV(text) {
        allQuestions = [];
        const lines = text.split('\n');
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            // è™•ç†å¯èƒ½æœ‰é€—è™Ÿçš„å…§å®¹ (ç°¡å–®ç‰ˆ)
            const parts = line.split(',');
            if (parts.length >= 3) {
                allQuestions.push({
                    type: parts[0].trim(),
                    content: parts[1].trim(),
                    answer: parts[2].trim()
                });
            }
        });

        if (allQuestions.length === 0) {
            alert("é¡Œåº«æ˜¯ç©ºçš„ï¼");
            goHome();
            return;
        }

        // æ´—ç‰Œ
        allQuestions.sort(() => Math.random() - 0.5);
        currentIndex = 0;
        nextQuestion();
    }

    // é¡¯ç¤ºä¸‹ä¸€é¡Œ
    function nextQuestion() {
        if (currentIndex >= allQuestions.length) {
            alert("é¡Œç›®åšå®Œäº†ï¼å°‡é‡æ–°é–‹å§‹ã€‚");
            currentIndex = 0;
            allQuestions.sort(() => Math.random() - 0.5);
        }

        currentQ = allQuestions[currentIndex];
        
        // æ›´æ–°é€²åº¦æ¢
        document.getElementById('progress-text').innerText = `é€²åº¦: ${currentIndex + 1} / ${allQuestions.length}`;
        
        // é‡ç½®ä»‹é¢
        resetUI();

        // æ¸²æŸ“é¡Œç›®
        const display = document.getElementById('question-display');
        display.innerHTML = '';

        if (currentQ.type === 'text') {
            const textContent = currentQ.content.replace(/\\n/g, '\n');
            display.innerHTML = `<div class="q-text">${textContent}</div>`;
        } else {
            let imgName = currentQ.content;
            let desc = "";
            if (imgName.includes('|')) {
                const parts = imgName.split('|');
                imgName = parts[0];
                desc = parts[1];
            }
            // è‡ªå‹•è£œè·¯å¾‘
            const imgPath = `images/${imgName}`;
            let html = `<img src="${imgPath}" class="q-img" onerror="this.src=''; this.alt='âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•— (${imgName})'">`;
            if (desc) html += `<div class="q-desc">${desc}</div>`;
            display.innerHTML = html;
        }
    }

    // æª¢æŸ¥ç­”æ¡ˆ (æŒ‰é€å‡ºæ™‚)
    function checkAnswer() {
        const input = document.getElementById('answer-input');
        const userAns = input.value.trim().toUpperCase();
        const correctAns = currentQ.answer.trim().toUpperCase();
        const feedback = document.getElementById('feedback');

        if (!userAns) return;

        if (userAns === correctAns) {
            // âœ… ç­”å°ï¼šé¡¯ç¤ºç¶ è‰²ï¼Œ0.8ç§’å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ (æ¨¡ä»¿ Python)
            feedback.innerText = `âœ… ç­”å°ï¼ç­”æ¡ˆæ˜¯ ${correctAns}`;
            feedback.className = 'correct-msg';
            input.disabled = true;
            setTimeout(() => {
                currentIndex++;
                nextQuestion();
            }, 800);
        } else {
            // âŒ ç­”éŒ¯ï¼šé€²å…¥ã€Œç·´ç¿’æ¨¡å¼ã€
            feedback.innerText = `âŒ éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctAns}`;
            feedback.className = 'wrong-msg';
            enterPracticeMode();
        }
    }

    // ä¸çŸ¥é“ (ç›´æ¥çœ‹ç­”æ¡ˆ)
    function showAnswer() {
        const feedback = document.getElementById('feedback');
        feedback.innerText = `ğŸ’¡ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentQ.answer}`;
        feedback.className = 'wrong-msg';
        enterPracticeMode();
    }

    // é€²å…¥ç·´ç¿’æ¨¡å¼ (é–å®šåŸæœ¬è¼¸å…¥ï¼Œé–‹å•Ÿä¸‹æ–¹ç·´ç¿’å€)
    function enterPracticeMode() {
        // 1. é–å®šä¸Šæ–¹
        document.getElementById('answer-input').disabled = true;
        document.getElementById('btn-submit').style.display = 'none';
        document.getElementById('btn-dunno').style.display = 'none';

        // 2. é–‹å•Ÿä¸‹æ–¹
        document.getElementById('practice-area').style.display = 'block';
        document.getElementById('assess-buttons').style.display = 'flex';
        
        // 3. èšç„¦åˆ°ç·´ç¿’è¼¸å…¥æ¡†
        const pInput = document.getElementById('practice-input');
        pInput.value = '';
        pInput.className = ''; // é‡ç½®é¡è‰²
        pInput.focus();
    }

    // ç·´ç¿’è¼¸å…¥æ¡†çš„è®Šè‰²é‚è¼¯ (å³æ™‚æ¯”å°)
    function checkPracticeInput(val) {
        const correctAns = currentQ.answer.trim().toUpperCase();
        const pInput = document.getElementById('practice-input');
        
        // å¦‚æœè¼¸å…¥å…§å®¹(è½‰å¤§å¯«)è·Ÿç­”æ¡ˆä¸€æ¨£ï¼Œè®Šç¶ è‰²
        if (val.trim().toUpperCase() === correctAns) {
            pInput.className = 'correct-practice';
        } else {
            pInput.className = '';
        }
    }

    // è©•ä¼°æŒ‰éˆ• (æ±ºå®šé€™é¡Œä½•æ™‚å†å‡ºç¾)
    // æ¨¡ä»¿ Python çš„ logic: Vague æ’å…¥å¾Œé¢ä¸€é», Forgot æ’å…¥æ›´å¾Œé¢
    function assess(level) {
        // 1. å…ˆæŠŠé¡Œç›®å¾€å¾Œå¡
        if (level === 'vague') {
            // æ’åœ¨ç›®å‰ä½ç½® + 3 çš„åœ°æ–¹
            allQuestions.splice(currentIndex + 3, 0, currentQ);
        } else if (level === 'forgot') {
            // æ’åœ¨ç›®å‰ä½ç½® + 8 çš„åœ°æ–¹ (æˆ–æ˜¯æœ€å¾Œé¢)
            allQuestions.splice(currentIndex + 8, 0, currentQ);
        }
        // level === 'clear' å°±ä¸åšä»»ä½•äº‹ï¼Œç›´æ¥ä¸‹ä¸€é¡Œ

        // 2. ç§»å‹•æŒ‡æ¨™ä¸¦æ›é¡Œ
        currentIndex++;
        nextQuestion();
    }

    function resetUI() {
        // æ¸…ç©ºå›é¥‹
        document.getElementById('feedback').innerText = '';
        document.getElementById('feedback').className = '';
        
        // é‡ç½®ä¸»è¼¸å…¥æ¡†
        const input = document.getElementById('answer-input');
        input.value = '';
        input.disabled = false;
        input.focus();
        document.getElementById('btn-submit').style.display = 'block';
        document.getElementById('btn-dunno').style.display = 'block';

        // éš±è—ç·´ç¿’å€
        document.getElementById('practice-area').style.display = 'none';
        document.getElementById('assess-buttons').style.display = 'none';
    }

    function goHome() {
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('menu-area').style.display = 'flex';
        document.getElementById('app-title').style.display = 'block';
    }

</script>

</body>
</html>
